<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamShare P2P</title>
    
    <!-- 1. USE SPECIFIC STABLE VERSION (1.9.7) TO FIX HANGING -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@1.9.7/webtorrent.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { background: #0a0a0a; color: #fff; font-family: sans-serif; margin: 0; overflow: hidden; }
        
        /* UPLOAD SCREEN */
        #screen-upload {
            height: 100vh; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .btn-select {
            background: #E50914; padding: 15px 40px; border-radius: 50px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; border: none; color: white;
        }
        
        /* PLAYER SCREEN */
        #screen-player { display: none; width: 100vw; height: 100vh; position: relative; }
        #video-container { width: 100%; height: 100%; background: black; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; max-height: 100vh; }
        
        /* INFO BAR */
        .info-bar {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.8);
            padding: 15px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center;
        }
        input { background: #222; border: 1px solid #444; color: #ddd; padding: 8px; width: 200px; border-radius: 4px; }
        
        /* DEBUG LOG */
        #log { position: fixed; top: 0; left: 0; background: rgba(0,0,0,0.5); color: lime; font-family: monospace; padding: 5px; font-size: 10px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="log">Init...</div>

    <!-- 1. UPLOAD SCREEN -->
    <div id="screen-upload">
        <h1 style="margin-bottom: 10px;">P2P Video Host</h1>
        <p id="status-text" style="color: #aaa; margin-bottom: 30px;">Select a video to create a stream link</p>
        
        <button class="btn-select" onclick="document.getElementById('fileInput').click()">Select Video</button>
        <input type="file" id="fileInput" style="display:none" accept="video/*" onchange="startUpload(this)">
    </div>

    <!-- 2. PLAYER SCREEN -->
    <div id="screen-player">
        <div id="video-container"></div>
        <div class="info-bar">
            <div>
                <span style="color:#aaa">Link:</span>
                <input type="text" id="share-link" readonly onclick="this.select()">
            </div>
            <div style="text-align: right;">
                <span id="peers">0 Peers</span> | <span id="speed">0 MB/s</span>
            </div>
        </div>
    </div>

    <script>
        function log(msg) { document.getElementById('log').innerText = msg; }

        // 1. CHECK LIBRARY LOAD
        if (typeof WebTorrent === 'undefined') {
            alert("Error: WebTorrent library blocked. Please disable AdBlock/Tracking Protection.");
            log("Library Missing");
        } else {
            log("Library Loaded. Ready.");
        }

        const client = new WebTorrent();
        const trackers = [
            'wss://tracker.openwebtorrent.com',
            'wss://tracker.btorrent.xyz',
            'wss://tracker.files.fm:7073/announce'
        ];

        // 2. CHECK IF VISITOR IS A DOWNLOADER
        if (window.location.hash.includes('#magnet=')) {
            const magnet = decodeURIComponent(window.location.hash.substring(8));
            startStream(magnet);
        }

        // 3. UPLOAD LOGIC
        function startUpload(input) {
            const file = input.files[0];
            if (!file) return;

            log("File selected: " + file.name);
            document.getElementById('status-text').innerText = "Processing " + file.name + "... (Please Wait)";
            document.querySelector('.btn-select').style.display = 'none';

            // Force Immediate Seed (No custom config to avoid errors)
            client.seed(file, { announce: trackers }, (torrent) => {
                log("Torrent Created: " + torrent.infoHash);
                
                const link = window.location.origin + window.location.pathname + '#magnet=' + encodeURIComponent(torrent.magnetURI);
                
                document.getElementById('share-link').value = link;
                
                // Switch View
                document.getElementById('screen-upload').style.display = 'none';
                document.getElementById('screen-player').style.display = 'block';
                
                // Start Playing Self
                renderVideo(torrent);
            });
        }

        // 4. DOWNLOAD LOGIC
        function startStream(magnet) {
            log("Connecting to swarm...");
            document.getElementById('screen-upload').style.display = 'none';
            document.getElementById('screen-player').style.display = 'block';
            document.getElementById('share-link').value = window.location.href;

            client.add(magnet, { announce: trackers }, (torrent) => {
                log("Metadata received. Peers: " + torrent.numPeers);
                renderVideo(torrent);
            });
        }

        // 5. RENDERER
        function renderVideo(torrent) {
            const file = torrent.files.find(f => f.name.match(/\.(mp4|webm|mkv|mov)$/i)) || torrent.files[0];
            
            file.renderTo('#video-container', { autoplay: true, controls: true }, (err, elem) => {
                if (err) {
                    log("Render Error: " + err.message);
                    alert("Error playing video: " + err.message);
                    return;
                }
                log("Playing: " + file.name);
                elem.style.width = "100%";
                elem.style.height = "100%";
            });

            // Stats Loop
            setInterval(() => {
                document.getElementById('peers').innerText = torrent.numPeers + " Peers";
                document.getElementById('speed').innerText = (torrent.downloadSpeed / 1024 / 1024).toFixed(2) + " MB/s";
            }, 1000);
        }
        
        // Prevent Tab Close
        window.onbeforeunload = function() {
            if (client.torrents.length > 0) return "Stream is active";
        };
    </script>
</body>
</html>
