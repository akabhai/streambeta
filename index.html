<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- !!! CRITICAL FIX: ALLOW WEBSOCKETS & BLOBS !!! -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; frame-src *; style-src * 'unsafe-inline';">
    
    <title>StreamShare Cinema</title>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #000; --surface: #141414; --primary: #E50914; --text: #fff; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow-x: hidden; }
        
        /* Fullscreen Player Container */
        .player-container {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            position: relative;
        }

        /* The Video Element */
        video {
            width: 100%;
            height: 100%;
            max-height: 100vh;
            object-fit: contain; /* Ensures video isn't stretched */
        }

        /* Overlays */
        .overlay-ui {
            position: absolute;
            top: 20px; left: 20px; right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to video */
        }
        
        .badge {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: auto;
        }

        .controls {
            position: absolute;
            bottom: 20px; right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: 0.2s;
            font-weight: bold;
            text-decoration: none;
        }
        .btn:hover { background: var(--primary); }

        /* Upload Screen */
        #upload-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            text-align: center;
        }
        
        .drop-box {
            border: 2px dashed #444;
            padding: 50px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        .drop-box:hover { border-color: var(--primary); background: #1a1a1a; }
        
        /* Loading Spinner */
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Share Modal */
        .modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            z-index: 50;
            display: none;
            text-align: center;
            border: 1px solid #333;
            min-width: 300px;
        }
        .modal input {
            width: 100%;
            padding: 10px;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            margin: 15px 0;
            border-radius: 5px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- UPLOAD SCREEN -->
    <div id="upload-screen">
        <div class="drop-box" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-play-circle fa-4x" style="color: var(--primary); margin-bottom: 20px;"></i>
            <h1>Stream Video</h1>
            <p style="color: #888;">Select MP4, MKV, or WEBM</p>
            <input type="file" id="file-input" accept="video/*" style="display:none">
        </div>
        <div id="preparing-ui" class="hidden" style="margin-top: 20px;">
            <div class="spinner" style="margin: 0 auto 10px auto;"></div>
            <p>Generating Stream Link...</p>
        </div>
    </div>

    <!-- PLAYER SCREEN -->
    <div id="player-screen" class="hidden">
        <div class="player-container" id="video-wrapper">
            <!-- Video injects here -->
            <div id="buffering" style="position: absolute;">
                <div class="spinner"></div>
                <p style="margin-top:10px; text-shadow: 0 2px 5px black;">Connecting to peers...</p>
            </div>
        </div>

        <div class="overlay-ui">
            <div class="badge">
                <i class="fas fa-video"></i> <span id="file-title">Loading...</span>
            </div>
            <div class="badge">
                <i class="fas fa-users"></i> <span id="peers-count">0</span>
                <span style="margin: 0 5px; opacity: 0.5;">|</span>
                <i class="fas fa-bolt"></i> <span id="speed-count">0 MB/s</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="toggleShare()"><i class="fas fa-share-alt"></i> Share</button>
            <a id="download-btn" class="btn hidden" href="#" download><i class="fas fa-download"></i> Save</a>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="share-modal" class="modal">
        <h3>Share Stream</h3>
        <div id="qrcode" style="display:flex; justify-content:center; margin: 10px 0;"></div>
        <input type="text" id="share-link" readonly>
        <button class="btn" style="background: var(--primary); width: 100%;" onclick="copyLink()">Copy Link</button>
        <p style="color:#e74c3c; font-size: 0.8rem; margin-top: 10px;">âš  Don't close this tab or stream stops!</p>
        <button class="btn" style="background: transparent; margin-top: 10px;" onclick="toggleShare()">Close</button>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // Massive list of trackers to ensure connection works
        const trackers = [
            'wss://tracker.openwebtorrent.com',
            'wss://tracker.btorrent.xyz',
            'wss://tracker.webtorrent.dev',
            'wss://tracker.files.fm:7073/announce',
            'wss://tracker.fastcast.nz',
            'wss://tracker.peer.ooo',
            'wss://tracker.sloppyta.co:443/announce',
            'wss://tracker.novage.com.ua:443/announce'
        ];

        const client = new WebTorrent({
            tracker: {
                rtcConfig: {
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:global.stun.twilio.com:3478" }
                    ]
                }
            }
        });

        // Ignore benign websocket errors (they happen on public trackers)
        client.on('error', (err) => { console.log("Client warning (ignored):", err.message); });

        // --- 2. ROUTING ---
        const params = new URLSearchParams(window.location.search);
        const magnet = params.get('m');
        const title = params.get('t');

        if (magnet) {
            startStream(magnet, title);
        }

        // --- 3. UPLOAD LOGIC ---
        document.getElementById('file-input').onchange = function(e) {
            const file = e.target.files[0];
            if(!file) return;

            document.querySelector('.drop-box').classList.add('hidden');
            document.getElementById('preparing-ui').classList.remove('hidden');

            client.seed(file, { announce: trackers }, (torrent) => {
                const link = `${window.location.origin}${window.location.pathname}?m=${encodeURIComponent(torrent.magnetURI)}&t=${encodeURIComponent(file.name)}`;
                
                // Host immediately becomes a viewer
                startStream(torrent.magnetURI, file.name, true, link);
            });
        };

        // --- 4. STREAMING LOGIC ---
        function startStream(magnetURI, filename, isHost = false, hostLink = null) {
            document.getElementById('upload-screen').classList.add('hidden');
            document.getElementById('player-screen').classList.remove('hidden');
            document.getElementById('file-title').innerText = filename || "Stream";

            // If host, we already have torrent. If leecher, add it.
            let torrent = client.get(magnetURI) || client.add(magnetURI, { announce: trackers });

            torrent.on('ready', () => {
                // Find the video file
                const file = torrent.files.find(f => f.name.endsWith('.mp4') || f.name.endsWith('.mkv') || f.name.endsWith('.webm')) || torrent.files[0];

                // Render directly to DIV (Magic Streaming)
                file.renderTo('#video-wrapper', {
                    autoplay: true,
                    controls: true, // Use browser native controls for best compatibility
                    muted: false
                }, (err, elem) => {
                    if(err) return alert("Error playing video: " + err.message);
                    document.getElementById('buffering').classList.add('hidden');
                    
                    // Style the injected video element
                    elem.style.height = "100%";
                    elem.style.width = "100%";
                });

                // Setup Download Button (Streaming downloads in background)
                file.getBlobURL((err, url) => {
                    if(!err) {
                        const btn = document.getElementById('download-btn');
                        btn.href = url;
                        btn.download = file.name;
                        btn.classList.remove('hidden');
                    }
                });
            });

            // Update UI Stats
            setInterval(() => {
                document.getElementById('speed-count').innerText = (torrent.downloadSpeed / 1024 / 1024).toFixed(2) + " MB/s";
                document.getElementById('peers-count').innerText = torrent.numPeers;
                
                // If buffering and have peers, hide buffer text
                if(torrent.downloadSpeed > 0) {
                    document.getElementById('buffering').classList.add('hidden');
                }
            }, 1000);

            // Setup Share Modal
            const link = hostLink || window.location.href;
            document.getElementById('share-link').value = link;
            new QRCode(document.getElementById('qrcode'), { text: link, width: 128, height: 128 });

            // If Host, show share modal automatically
            if(isHost) toggleShare();
        }

        // --- 5. UI HELPERS ---
        function toggleShare() {
            const modal = document.getElementById('share-modal');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
        }

        function copyLink() {
            const copyText = document.getElementById("share-link");
            copyText.select();
            document.execCommand("copy");
            alert("Link Copied!");
        }

        // Prevent closing tab
        window.onbeforeunload = function() {
            if (client.torrents.length > 0) return "Stream is active.";
        };
    </script>
</body>
</html>
