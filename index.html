<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Streamer</title>
    
    <!-- 1. LOAD LIBRARIES FROM UNPKG (Most compatible CDN) -->
    <script src="https://unpkg.com/webtorrent@latest/webtorrent.min.js"></script>
    <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; margin: 0; }
        
        /* ERROR BOX */
        #error-box { background: red; color: white; padding: 10px; display: none; }

        /* UPLOAD SCREEN */
        #upload-screen { padding-top: 50px; }
        .btn { background: #e50914; color: white; padding: 15px 30px; font-size: 20px; border: none; cursor: pointer; border-radius: 5px; margin-top: 20px; }
        
        /* PLAYER SCREEN */
        #player-screen { display: none; height: 100vh; width: 100%; }
        #video-box { width: 100%; height: 80%; background: black; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; }
        
        /* SHARE INFO */
        #share-info { padding: 10px; background: #222; }
        input { width: 80%; padding: 10px; background: #000; color: #fff; border: 1px solid #555; }
    </style>
</head>
<body>

    <!-- ERROR DISPLAY -->
    <div id="error-box"></div>

    <!-- SCREEN 1: UPLOAD -->
    <div id="upload-screen">
        <h1>Host a Video</h1>
        <p>Select MP4, MKV, or WEBM</p>
        <button class="btn" onclick="document.getElementById('fileIn').click()">Select Video</button>
        <input type="file" id="fileIn" style="display:none" accept="video/*" onchange="startSeed(this)">
        <p id="status">Ready</p>
    </div>

    <!-- SCREEN 2: PLAYER & SHARE -->
    <div id="player-screen">
        <div id="video-box"></div>
        <div id="share-info">
            <p>Peers: <span id="peers">0</span> | Speed: <span id="speed">0</span></p>
            <input type="text" id="share-link" readonly onclick="this.select()">
            <br>
            <button onclick="alert('Copy the link above!')" style="margin-top:5px;">Copy Link</button>
        </div>
    </div>

    <script>
        // 1. INITIALIZE CLIENT
        const client = new WebTorrent();
        
        // Trackers help devices find each other
        const trackers = [
            'wss://tracker.openwebtorrent.com',
            'wss://tracker.btorrent.xyz',
            'wss://tracker.files.fm:7073/announce',
            'wss://tracker.webtorrent.dev'
        ];

        // 2. CHECK FOR DOWNLOAD LINK
        if (window.location.hash.indexOf('#magnet=') > -1) {
            const magnet = decodeURIComponent(window.location.hash.substring(8));
            startStream(magnet);
        }

        // 3. UPLOAD FUNCTION
        function startSeed(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('status').innerText = "Creating Link... Please Wait.";

            // SEEDING
            client.seed(file, { announce: trackers }, function (torrent) {
                
                // Generate Link
                const link = window.location.origin + window.location.pathname + '#magnet=' + encodeURIComponent(torrent.magnetURI);
                
                // Switch UI
                showPlayer(link);
                
                // Start Playing (Host view)
                renderVideo(torrent);
            });
        }

        // 4. DOWNLOAD FUNCTION
        function startStream(magnet) {
            showPlayer(window.location.href);
            document.getElementById('status').innerText = "Connecting...";

            client.add(magnet, { announce: trackers }, function (torrent) {
                renderVideo(torrent);
            });
        }

        // 5. VIDEO RENDERER
        function renderVideo(torrent) {
            const file = torrent.files.find(f => f.name.endsWith('.mp4') || f.name.endsWith('.webm') || f.name.endsWith('.mkv')) || torrent.files[0];
            
            // Render directly to the div
            file.renderTo('#video-box', { autoplay: true, controls: true }, function (err, elem) {
                if (err) showError(err.message);
                elem.style.height = "100%";
                elem.style.width = "100%";
            });

            // Update Stats
            setInterval(() => {
                document.getElementById('peers').innerText = torrent.numPeers;
                document.getElementById('speed').innerText = (torrent.downloadSpeed / 1024 / 1024).toFixed(2) + ' MB/s';
            }, 1000);
        }

        // 6. HELPER FUNCTIONS
        function showPlayer(link) {
            document.getElementById('upload-screen').style.display = 'none';
            document.getElementById('player-screen').style.display = 'block';
            document.getElementById('share-link').value = link;
        }

        function showError(msg) {
            const box = document.getElementById('error-box');
            box.style.display = 'block';
            box.innerText = "ERROR: " + msg;
        }
        
        // Error catching for the library itself
        window.onerror = function(msg, url, line) {
            showError(msg);
            return false;
        };
    </script>
</body>
</html>
